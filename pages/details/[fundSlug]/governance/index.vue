<template>
  <div class="page-governance">
    <UiDataRowCard title="Governance Settings" class="data_row_card">
      <template #body>
        <FundOverviewGovernance :fund="fund" />
      </template>
    </UiDataRowCard>

    <UiMainCard
      title="Governance Activity"
      :subtitle="pendingProposalsCountText"
    >
      <template #header-right>
        <UiDropdown
          :options="dropdownOptionsLabels"
          label="Create Proposal"
          @update:selected="selectOption"
          @click="startFetch"
        />
      </template>
      <template #tools>
        <v-btn
          class="tools__all-activity-btn text-secondary"
          variant="outlined"
        >
          <div>All Activity</div>
          <div class="tools__all-activity-btn__subtext">
            ({{ proposalsCountText }})
          </div>
          <Icon icon="mdi:filter-variant" width="1rem" />
        </v-btn>
        <div class="tools__success-rate">
          <div class="tools__val">
            {{ proposalsSuccessRate }}
          </div>
          <div class="tools__subtext">Success Rate</div>
        </div>
      </template>
      <<<<<<< HEAD:pages/details/[id]/governance/index.vue
      <FundGovernanceTableProposals
        :items="governanceProposals"
        :loading="loadingProposals"
      />
      =======
      <FundGovernanceProposalsTable
        :items="governanceProposals"
        :loading="loadingProposals"
      />
      >>>>>>>
      92664e0a865c673b3a44fe77ee4d6ba27188f7fa:pages/details/[fundSlug]/governance/index.vue
    </UiMainCard>

    <UiMainCard title="Trending Delegates" subtitle="4 Delegated Wallets">
      <template #header-right>
        <UiLinkExternalButton
          class="main-card__manage-button"
          title="Manage Delegation"
          :href="manageDelegateUrl"
        />
      </template>
      <TableTrendingDelegates :items="trendingDelegates" />
    </UiMainCard>
  </div>
</template>

<script setup lang="ts">
// types
import RethinkFundGovernor from "~/assets/contracts/RethinkFundGovernor.json";
import type IFund from "~/types/fund";
import type ITrendingDelegates from "~/types/trending_delegates";

// components
import TableTrendingDelegates from "~/components/fund/governance/TableTrendingDelegates.vue";
import { useFundStore } from "~/store/fund.store";
import { useGovernanceProposalsStore } from "~/store/governance_proposals.store";
import { useToastStore } from "~/store/toast.store";
import { useWeb3Store } from "~/store/web3.store";
import { ClockMode } from "~/types/enums/clock_mode";
import {
  ProposalState,
  ProposalStateMapping,
} from "~/types/enums/governance_proposal";
const router = useRouter();
const fundStore = useFundStore();
const toastStore = useToastStore();
const web3Store = useWeb3Store();
const governanceProposalStore = useGovernanceProposalsStore();

// dummy data for manage delegate button
const manageDelegateUrl = "https://www.google.com";

// dummy data governance activity
const governanceProposals = computed(() => {
  const proposals = governanceProposalStore.getProposals(
    web3Store.chainId,
    fundStore.fund?.address
  );

  // Sort the events by createdTimestamp
  proposals.sort((a, b) => {
    const timestampA = a.createdTimestamp;
    const timestampB = b.createdTimestamp;
    return timestampB - timestampA;
  });

  return proposals;
});

const proposalsCountText = computed(() => {
  if (governanceProposals.value.length === 1) {
    return "1 Proposal";
  }
  return governanceProposals.value.length + " Proposals";
});
const pendingProposals = computed(() => {
  return governanceProposals.value.filter(
    (proposal) => proposal.state === ProposalState.Pending
  );
});
const pendingProposalsCountText = computed(() => {
  if (pendingProposals.value.length === 1) {
    return "1 Pending Proposal";
  }
  return pendingProposals.value.length + " Pending Proposals";
});
const proposalsSuccessRate = computed(() => {
  const successProposals = governanceProposals.value.filter((proposal) =>
    [ProposalState.Succeeded, ProposalState.Executed].includes(proposal.state)
  );
  const allFinishedProposalsCount =
    governanceProposals.value.length - pendingProposals.value.length;
  let successRate = 0;
  if (allFinishedProposalsCount) {
    successRate =
      successProposals.length /
      (governanceProposals.value.length - pendingProposals.value.length);
  }
  return formatPercent(successRate, false);
});

// fetchProposals can be a super long-lasting process, so if the user changes
// page we want to stop fetching proposals.
const shouldFetchProposals = ref(false);

// Dummy data for trending delegates
const trendingDelegates: ITrendingDelegates[] = [
  {
    delegated_members: "0x1f98dgdaddasdfgF984",
    delegators: "16 Members",
    impact: "10%",
    voting_power: "570.000.000 SOON",
  },
  {
    delegated_members: "0xEd2026078669d1135991E850c88Cf71cdAEB4d00",
    delegators: "13 Members",
    impact: "20%",
    voting_power: "850.000.000 SOON",
  },
  {
    delegated_members: "0x1f98dgdaddasdfgF984",
    delegators: "8 Members",
    impact: "8%",
    voting_power: "440.000.000 SOON",
  },
  {
    delegated_members: "0xEd2026078669d1135991E850c88Cf71cdAEB4d00",
    delegators: "5 Members",
    impact: "16%",
    voting_power: "720.000.000 SOON",
  },
];

type DropdownOption = {
  click: () => void;
};

const dropdownOptions: Record<string, DropdownOption> = {
  "Direct Execution": {
    click: () => {
      // change route to direct execution

      router.push(
        `/details/${fundStore.selectedFundSlug}/governance/direct-execution`
      );
    },
  },
  "Delegated permissions": {
    click: () => {
      console.log("Delegated permissions");
    },
  },
  "NAV Methods": {
    click: () => {
      console.log("NAV Methods");
    },
  },
  "Fund Settings": {
    click: () => {
      console.log("Fund Settings");
    },
  },
};

const dropdownOptionsLabels = Object.keys(dropdownOptions);

const selectOption = (option: string) => {
  if (dropdownOptions[option]) {
    dropdownOptions[option].click();
  } else {
    console.error("Option not found");
  }
};

const fund = useAttrs().fund as IFund;

const proposalCreatedEventInputs =
  RethinkFundGovernor.abi.find(
    (event) => event.name === "ProposalCreated" && event.type === "event"
  )?.inputs ?? [];
const loadingProposals = ref(false);

/**
 * Example data of one decoded proposal, data that came from the ProposalCreated event:
 *
 * {
 *     "proposalId": "100928362673962953747976977800166144740308816222406020172969996550573666024331",
 *     "proposer": "0x66158bf6752FA6191E70Ab06Cfc345dE0D9A0ba5",
 *     "targets":
 *     [
 *         "0x0dCd5D9cF6DFF56E7Ce2cbed1d39369e1B5f2ac4",
 *         "0x0dCd5D9cF6DFF56E7Ce2cbed1d39369e1B5f2ac4",
 *         "0x0dCd5D9cF6DFF56E7Ce2cbed1d39369e1B5f2ac4",
 *         "0x0dCd5D9cF6DFF56E7Ce2cbed1d39369e1B5f2ac4",
 *         "0x0Ca068aB532114F25a91d083e2af7CEd2A6e602C"
 *     ],
 *     "values":
 *     [
 *         "0",
 *         "0",
 *         "0",
 *         "0",
 *         "0"
 *     ],
 *     "signatures":
 *     [
 *         "",
 *         "",
 *         "",
 *         "",
 *         ""
 *     ],
 *     "calldatas":
 *     [
 *         "0x93a1de3f00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000fc000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000b400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000340000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000addd25a91563696d8567df78d5a01c9a991f9b8000000000000000000000000000000000000000000000000000000000000012000000000000000000000000053d76f967de13e7f95e90196438dce695ecfa957000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064802431fb00000000000000000000000053d76f967de13e7f95e90196438dce695ecfa9570000000000000000000000008f3cf7ad23cd3cadbd9735aff958023239c6a063000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b7b22706f736974696f6e4e616d65223a2253484e222c2276616c756174696f6e536f75726365223a223120496e6368202853484e2f44414929227d000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000248a64e3edd3f521ef2aa6a3e804845b5a1c800800000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000966c697175696443616c63756c6174696f6e526561644f6e6c792828616464726573732c616464726573732c62797465732c616464726573732c616464726573732c626f6f6c2c75696e743235362c75696e743235362c75696e74323536295b5d2c616464726573732c616464726573732c75696e743235362c626f6f6c2c75696e743235362c75696e743235362c61646472657373290000000000000000000000000000000000000000000000000000000000000000000000000000000002846b8ddb710000000000000000000000000000000000000000000000000000000000000100000000000000000000000000067d74a54ac281914019d5b79943388e0f4d417b0000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac40000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000049f05ad4a19eeb98f2f09c86096feefab99f2b4a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001200000000000000000000000006944e4ef181169a12a980d3e8a81f0e6b7e142ad0000000000000000000000008f3cf7ad23cd3cadbd9735aff958023239c6a0630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004f7b22706f736974696f6e4e616d65223a22383053484e2d3230444149222c2276616c756174696f6e536f75726365223a22556e69737761702056322028383053484e2d32304441492f44414929227d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000be0b0c435ea1156f76d3e116fbd5606743ab179a000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001076616c75654f66286164647265737329000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024a48028aa000000000000000000000000067d74a54ac281914019d5b79943388e0f4d417b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000347b22706f736974696f6e4e616d65223a22444f435450222c2276616c756174696f6e536f75726365223a2252657468696e6b227d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac40000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac40000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac4",
 *         "0xe9ae21ea0000000000000000000000000000000000000000000000000000000000000000",
 *         "0xe9ae21ea0000000000000000000000000000000000000000000000000000000000000002",
 *         "0xe9ae21ea0000000000000000000000000000000000000000000000000000000000000003",
 *         "0x33a0480c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac493a1de3f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000116000000000000000000000000000000000000000000000000000000000000021c00000000000000000000000000000000000000000000000000000000000003220000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000820000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000008200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000082000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000820000000000000000000000000000000000000000000000000000000000001040000000000000000000000000000000000000000000000000000000000000108000000000000000000000000000000000000000000000000000000000000010c000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000001140000000000000000000000000000000000000000000000000000000000000118000000000000000000000000000000000000000000000000000000000000011c000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001240000000000000000000000000000000000000000000000000000000000000128000000000000000000000000000000000000000000000000000000000000012c000000000000000000000000000000000000000000000000000000000000013000000000000000000000000000000000000000000000000000000000000001340000000000000000000000000000000000000000000000000000000000000138000000000000000000000000000000000000000000000000000000000000013c000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001440000000000000000000000000000000000000000000000000000000000000148000000000000000000000000000000000000000000000000000000000000014c000000000000000000000000000000000000000000000000000000000000015000000000000000000000000000000000000000000000000000000000000001540000000000000000000000000000000000000000000000000000000000000158000000000000000000000000000000000000000000000000000000000000015c000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001640000000000000000000000000000000000000000000000000000000000000168000000000000000000000000000000000000000000000000000000000000016c000000000000000000000000000000000000000000000000000000000000017000000000000000000000000000000000000000000000000000000000000001740000000000000000000000000000000000000000000000000000000000000178000000000000000000000000000000000000000000000000000000000000017c000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001840000000000000000000000000000000000000000000000000000000000000188000000000000000000000000000000000000000000000000000000000000018c000000000000000000000000000000000000000000000000000000000000019000000000000000000000000000000000000000000000000000000000000001940000000000000000000000000000000000000000000000000000000000000198000000000000000000000000000000000000000000000000000000000000019c00000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001a400000000000000000000000000000000000000000000000000000000000001a800000000000000000000000000000000000000000000000000000000000001ac00000000000000000000000000000000000000000000000000000000000001b000000000000000000000000000000000000000000000000000000000000001b400000000000000000000000000000000000000000000000000000000000001b800000000000000000000000000000000000000000000000000000000000001bc00000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000001c400000000000000000000000000000000000000000000000000000000000001c800000000000000000000000000000000000000000000000000000000000001cc00000000000000000000000000000000000000000000000000000000000001d000000000000000000000000000000000000000000000000000000000000001d400000000000000000000000000000000000000000000000000000000000001d800000000000000000000000000000000000000000000000000000000000001dc00000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000001e400000000000000000000000000000000000000000000000000000000000001e800000000000000000000000000000000000000000000000000000000000001ec00000000000000000000000000000000000000000000000000000000000001f000000000000000000000000000000000000000000000000000000000000001f400000000000000000000000000000000000000000000000000000000000001f800000000000000000000000000000000000000000000000000000000000001fc000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002040000000000000000000000000000000000000000000000000000000000000208000000000000000000000000000000000000000000000000000000000000020c000000000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000002140000000000000000000000000000000000000000000000000000000000000218000000000000000000000000000000000000000000000000000000000000021c000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002240000000000000000000000000000000000000000000000000000000000000228000000000000000000000000000000000000000000000000000000000000022c000000000000000000000000000000000000000000000000000000000000023000000000000000000000000000000000000000000000000000000000000002340000000000000000000000000000000000000000000000000000000000000238000000000000000000000000000000000000000000000000000000000000023c000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002440000000000000000000000000000000000000000000000000000000000000248000000000000000000000000000000000000000000000000000000000000024c000000000000000000000000000000000000000000000000000000000000025000000000000000000000000000000000000000000000000000000000000002540000000000000000000000000000000000000000000000000000000000000258000000000000000000000000000000000000000000000000000000000000025c000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002640000000000000000000000000000000000000000000000000000000000000268000000000000000000000000000000000000000000000000000000000000026c000000000000000000000000000000000000000000000000000000000000027000000000000000000000000000000000000000000000000000000000000002740000000000000000000000000000000000000000000000000000000000000278000000000000000000000000000000000000000000000000000000000000027c000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000002840000000000000000000000000000000000000000000000000000000000000288000000000000000000000000000000000000000000000000000000000000028c000000000000000000000000000000000000000000000000000000000000029000000000000000000000000000000000000000000000000000000000000002940000000000000000000000000000000000000000000000000000000000000298000000000000000000000000000000000000000000000000000000000000029c00000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000002a400000000000000000000000000000000000000000000000000000000000002a800000000000000000000000000000000000000000000000000000000000002ac00000000000000000000000000000000000000000000000000000000000002b000000000000000000000000000000000000000000000000000000000000002b400000000000000000000000000000000000000000000000000000000000002b800000000000000000000000000000000000000000000000000000000000002bc00000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000002c400000000000000000000000000000000000000000000000000000000000002c800000000000000000000000000000000000000000000000000000000000002cc00000000000000000000000000000000000000000000000000000000000002d000000000000000000000000000000000000000000000000000000000000002d400000000000000000000000000000000000000000000000000000000000002d800000000000000000000000000000000000000000000000000000000000002dc00000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000002e400000000000000000000000000000000000000000000000000000000000002e800000000000000000000000000000000000000000000000000000000000002ec00000000000000000000000000000000000000000000000000000000000002f000000000000000000000000000000000000000000000000000000000000002f400000000000000000000000000000000000000000000000000000000000002f800000000000000000000000000000000000000000000000000000000000002fc00000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000304000000000000000000000000000000000000000000000000000000000000030800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000fc00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000b4000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000340000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000addd25a91563696d8567df78d5a01c9a991f9b800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000002000000000000000000000000053d76f967de13e7f95e90196438dce695ecfa9570000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000020802431fb00000000000000000000000053d76f967de13e7f95e90196438dce6900000000000000000000000000000000000000000000000000000000000000205ecfa9570000000000000000000000008f3cf7ad23cd3cadbd9735aff9580232000000000000000000000000000000000000000000000000000000000000002039c6a06300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003b00000000000000000000000000000000000000000000000000000000000000207b22706f736974696f6e4e616d65223a2253484e222c2276616c756174696f6e0000000000000000000000000000000000000000000000000000000000000020536f75726365223a223120496e6368202853484e2f44414929227d000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000248a64e3edd3f521ef2aa6a3e804845b5a1c80080000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000009600000000000000000000000000000000000000000000000000000000000000206c697175696443616c63756c6174696f6e526561644f6e6c7928286164647265000000000000000000000000000000000000000000000000000000000000002073732c616464726573732c62797465732c616464726573732c6164647265737300000000000000000000000000000000000000000000000000000000000000202c626f6f6c2c75696e743235362c75696e743235362c75696e74323536295b5d00000000000000000000000000000000000000000000000000000000000000202c616464726573732c616464726573732c75696e743235362c626f6f6c2c756900000000000000000000000000000000000000000000000000000000000000206e743235362c75696e743235362c6164647265737329000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000028400000000000000000000000000000000000000000000000000000000000000206b8ddb7100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000100000000000000000000000000067d74a54ac281914019d5b79943388e00000000000000000000000000000000000000000000000000000000000000200f4d417b0000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e00000000000000000000000000000000000000000000000000000000000000201b5f2ac4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e00000000000000000000000000000000000000000000000000000000000000201b5f2ac4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000002000000000000000000000000049f05ad4a19eeb98f2f09c86096feefa0000000000000000000000000000000000000000000000000000000000000020b99f2b4a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000001200000000000000000000000006944e4ef181169a12a980d3e8a81f0e60000000000000000000000000000000000000000000000000000000000000020b7e142ad0000000000000000000000008f3cf7ad23cd3cadbd9735aff9580232000000000000000000000000000000000000000000000000000000000000002039c6a0630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004f00000000000000000000000000000000000000000000000000000000000000207b22706f736974696f6e4e616d65223a22383053484e2d3230444149222c22760000000000000000000000000000000000000000000000000000000000000020616c756174696f6e536f75726365223a22556e697377617020563220283830530000000000000000000000000000000000000000000000000000000000000020484e2d32304441492f44414929227d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000be0b0c435ea1156f76d3e116fbd5606743ab179a00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002076616c75654f6628616464726573732900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000020a48028aa000000000000000000000000067d74a54ac281914019d5b79943388e00000000000000000000000000000000000000000000000000000000000000200f4d417b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000207b22706f736974696f6e4e616d65223a22444f435450222c2276616c7561746900000000000000000000000000000000000000000000000000000000000000206f6e536f75726365223a2252657468696e6b227d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000200000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac4"
 *     ],
 *     "voteStart": "1718191316",
 *     "voteEnd": "1718623316",
 *     "description": "{\"title\":\"01 - NAV Methods\",\"description\":\"See details bellow\"}"
 * }
 *
 * TODO check first few 8 bytes of calldatas to see if the function signature matches any of ours, for example
 * to compare them with function signatures of our ABIs
 * TODO or just try decoding calldatas with our ABIs
 */
const parseProposals = async (chunkEvents: any[]) => {
  if (!fundStore.fund?.governanceToken.decimals) {
    console.error("No fund governance token decimals found.");
    toastStore.errorToast("No fund governance token decimals found.");
    return;
  }
  if (!fundStore.fund.clockMode?.mode) {
    console.error("Fund clock mode is unknown.");
    toastStore.errorToast("Fund clock mode is unknown.");
    return;
  }

  for (const event of chunkEvents) {
    console.log("event");
    console.log(event);
    const proposal = governanceProposalStore.decodeProposalCreatedEvent(event);
    if (!proposal) continue;

    const block = await fundStore.web3.eth.getBlock(event.blockNumber);
    proposal.createdTimestamp = Number(block.timestamp);
    proposal.createdDatetimeFormatted = formatDate(
      new Date(Number(block.timestamp) * 1000)
    );
    proposal.createdBlockNumber = event.blockNumber;

    // const voteStartDate = new Date(Number(proposal.voteStart) * 1000);
    // const voteEndDate = new Date(Number(proposal.voteEnd) * 1000);
    // console.log("Vote Start Date: ", voteStartDate);
    // console.log("Vote End Date: ", voteEndDate);

    const proposalState = await fundStore.fundGovernorContract.methods
      .state(proposal.proposalId)
      .call();
    proposal.state = ProposalStateMapping[proposalState];

    const votes = await fundStore.fundGovernorContract.methods
      .proposalVotes(proposal.proposalId)
      .call();
    console.log("proposal votes: ", votes);

    console.log(
      "get total supply at blockNumber: ",
      proposal.createdBlockNumber
    );
    // Get the Governance Token total supply of when the proposal was created.
    let totalSupply;
    try {
      totalSupply = await fundStore.fundGovernanceTokenContract.methods
        .totalSupply()
        .call({}, proposal.createdBlockNumber);
      proposal.totalSupply = totalSupply;
      proposal.totalSupplyFormatted = formatTokenValue(
        totalSupply,
        fundStore.fund?.governanceToken?.decimals
      );
    } catch (error: any) {
      // Sometimes it happens: missing trie node
      console.error("failed fetching total supply", error);
      proposal.totalSupplyFormatted = "N/A";
    }

    console.log(
      "proposal created blockNumber ",
      proposal.createdBlockNumber,
      " timestamp ",
      proposal.createdTimestamp
    );
    try {
      // To get quorum in time, we have to pass the timePoint, but it depends on the clock mode.
      // If clock mode is:
      // - timestamp: use proposal created timestamp
      // - blocknumber: use proposal created block number
      const timePoint =
        fundStore.fund?.clockMode?.mode === ClockMode.BlockNumber
          ? proposal.createdBlockNumber
          : proposal.createdTimestamp;

      const quorumWhenProposalCreated =
        await fundStore.fundGovernorContract.methods
          .quorumNumerator(timePoint)
          .call();
      proposal.quorumVotes = quorumWhenProposalCreated;
      proposal.quorumVotesFormatted = formatTokenValue(
        quorumWhenProposalCreated,
        fundStore.fund?.governanceToken?.decimals
      );
    } catch (e: any) {
      console.error("error fetching quorumVotes: ", e);
      proposal.quorumVotesFormatted = "N/A";
    }

    console.log("parse votes");
    if (votes) {
      const totalVotes =
        votes.forVotes + votes.abstainVotes + votes.againstVotes;
      proposal.totalVotes = totalVotes;
      proposal.totalVotesFormatted = formatTokenValue(
        totalVotes,
        fundStore.fund?.governanceToken.decimals
      );
      proposal.forVotes = votes.forVotes;
      proposal.abstainVotes = votes.abstainVotes;
      proposal.againstVotes = votes.againstVotes;
      proposal.forVotesFormatted = formatTokenValue(
        votes.forVotes,
        fundStore.fund?.governanceToken.decimals
      );
      proposal.abstainVotesFormatted = formatTokenValue(
        votes.abstainVotes,
        fundStore.fund?.governanceToken.decimals
      );
      proposal.againstVotesFormatted = formatTokenValue(
        votes.againstVotes,
        fundStore.fund?.governanceToken.decimals
      );

      if (proposal.quorumVotes) {
        let approval = Number(votes.forVotes) / Number(proposal.quorumVotes);
        // Limit approval percentage to 100% max.
        if (approval > 1) {
          approval = 1;
        }
        proposal.approval = approval;
        proposal.approvalFormatted = formatPercent(approval, false);
      } else {
        proposal.approvalFormatted = "N/A";
      }

      // Participation is totalVotes / totalSupply
      if (totalSupply) {
        let participation = Number(totalVotes) / Number(totalSupply);
        // Limit participation percentage to 100% max.
        if (participation > 1) {
          participation = 1;
        }
        proposal.participation = participation;
        proposal.participationFormatted = formatPercent(participation, false);
      } else {
        proposal.participationFormatted = "N/A";
      }
    }

    proposal.calldatasDecoded = [];
    for (const calldata of proposal.calldatas) {
      proposal.calldatasDecoded.push(
        governanceProposalStore.decodeProposalCallData(calldata)
      );
    }

    governanceProposalStore.storeProposal(
      web3Store.chainId,
      fundStore.fund?.address,
      proposal
    );
  }
};

const fetchProposals = async (
  rangeStartBlock: number,
  rangeEndBlock: number
) => {
  if (!fundStore.fund?.governanceToken.decimals) {
    console.error("No fund governance token decimals found.");
    toastStore.errorToast("No fund governance token decimals found.");
    return;
  }
  if (!fundStore.fund.clockMode?.mode) {
    console.error("Fund clock mode is unknown.");
    toastStore.errorToast("Fund clock mode is unknown.");
    return;
  }
  loadingProposals.value = true;

  // TODO arbitrum1 RPCs can take ranges of more blocks, like 1M, polygon cries if we use more than 3k
  // It looks like this range is arbitrary, specific to RPC, so we should try and guess it and increase exponentially
  // until they block us, and then we decrease it.
  // some RPCs can take more than 1M in arbitrum if logged in
  // let chunkSize = 1000000;
  let chunkSize = 3000;
  let maxValidChunkSize;

  // TODO we can do batch requests for example 10x3000
  // We have to fetch events in ranges, as we can't fetch all events at once because of RPC limits.
  // We fetch from the most recent to least recent block number.
  const targetDate = new Date("2024-04-01T00:00:00Z");
  const targetTimestamp = Math.floor(targetDate.getTime() / 1000);

  // From the largest number to the smallest number.
  if (rangeStartBlock > rangeEndBlock) {
    console.log("BIGGEST to smallest");
    for (let i = rangeStartBlock; i > rangeEndBlock; i -= chunkSize) {
      if (!shouldFetchProposals.value) return;

      const toBlock = i;
      let fromBlock = Math.max(i - chunkSize + 1, 0);
      const block = await fundStore.web3.eth.getBlock(toBlock);
      const toBlockTimestamp = new Date(Number(block.timestamp) * 1000);
      console.log(
        "fetch ProposalCreated events from: ",
        fromBlock,
        " to ",
        toBlock,
        " timestamp: ",
        toBlockTimestamp
      );

      let chunkEvents;
      while (chunkSize > 100 && chunkSize > 0) {
        console.log("getPastEvents chunkSize: ", chunkSize);
        try {
          chunkEvents = await fundStore.fundGovernorContract.getPastEvents(
            "ProposalCreated",
            {
              fromBlock,
              toBlock,
            }
          );
          console.log(
            "chunkevents fetched: ",
            chunkEvents,
            " chunksize: ",
            chunkSize,
            maxValidChunkSize
          );

          if (!maxValidChunkSize || chunkSize * 2 <= maxValidChunkSize) {
            chunkSize *= 2;
            console.log("new chunkSize: ", chunkSize);
          }
          break;
        } catch {
          chunkSize /= 2;
          maxValidChunkSize = chunkSize;
          console.log("reduce chunkSize: ", chunkSize);
          fromBlock = Math.max(i - chunkSize + 1, 0);
        }
      }

      parseProposals(chunkEvents);

      console.log(
        "set BlockFetchedRanges toBlock: ",
        toBlock,
        " fromBlock ",
        fromBlock
      );
      governanceProposalStore.setFundProposalsBlockFetchedRanges(
        web3Store.chainId,
        fundStore.fund?.address,
        toBlock,
        fromBlock
      );
      await new Promise((resolve) => setTimeout(resolve, 1000));

      const lastProposal =
        governanceProposals.value[governanceProposals.value.length];
      if (lastProposal?.createdTimestamp < targetTimestamp) {
        break;
      }
    }
  } else {
    console.log("smallest to BIGGEST");

    for (let i = rangeEndBlock; i < rangeStartBlock; i += chunkSize) {
      if (!shouldFetchProposals.value) return;
      const fromBlock = Math.max(i, 0);
      let toBlock = i + chunkSize - 1;
      const block = await fundStore.web3.eth.getBlock(toBlock);
      const toBlockTimestamp = new Date(Number(block.timestamp) * 1000);
      console.log(
        "fetch ProposalCreated events from: ",
        fromBlock,
        " to ",
        toBlock,
        " timestamp: ",
        toBlockTimestamp
      );

      let chunkEvents;
      while (chunkSize > 100 && chunkSize > 0) {
        console.log("getPastEvents chunkSize: ", chunkSize);
        try {
          chunkEvents = await fundStore.fundGovernorContract.getPastEvents(
            "ProposalCreated",
            {
              fromBlock,
              toBlock,
            }
          );
          console.log(
            "chunkevents fetched: ",
            chunkEvents,
            " chunksize: ",
            chunkSize,
            maxValidChunkSize
          );
          if (!maxValidChunkSize || chunkSize * 2 <= maxValidChunkSize) {
            chunkSize *= 2;
            console.log("new chunkSize: ", chunkSize);
          }
          break;
        } catch {
          chunkSize /= 2;
          maxValidChunkSize = chunkSize;
          console.log("reduce chunkSize: ", chunkSize);
          toBlock = Math.max(i + chunkSize - 1, 0);
        }
      }

      parseProposals(chunkEvents);

      governanceProposalStore.setFundProposalsBlockFetchedRanges(
        web3Store.chainId,
        fundStore.fund?.address,
        toBlock,
        fromBlock
      );
      // await new Promise(resolve => setTimeout(resolve, 1000));

      const lastProposal =
        governanceProposals.value[governanceProposals.value.length];
      if (lastProposal?.createdTimestamp < targetTimestamp) {
        break;
      }
    }
  }

  loadingProposals.value = false;
};

// TODO iterate over all already fetched proposals that are still votable and update their state (createdBlockNumber).
onMounted(() => {
  startFetch();
});
onBeforeUnmount(() => {
  console.log("Component is being unmounted, stopping the fetch");
  shouldFetchProposals.value = false;
  loadingProposals.value = false;
});

const startFetch = async () => {
  if (shouldFetchProposals.value) {
    console.log("stop fetching");
    shouldFetchProposals.value = false;
    loadingProposals.value = false;
    return;
  }
  console.log("\n\n________________________");
  console.log("fetch governance proposal events for fund: ", fund.address);
  shouldFetchProposals.value = true;

  const currentBlock = Number(await fundStore.web3.eth.getBlockNumber());
  console.log("currentBlock: ", currentBlock);

  const [mostRecentFetchedBlock, oldestFetchedBlock] =
    governanceProposalStore.getFundProposalsBlockFetchedRanges(
      web3Store.chainId,
      fundStore.fund?.address
    );
  console.log(
    "mostRecentFetchedBlock: ",
    mostRecentFetchedBlock,
    "oldestFetchedBlock:",
    oldestFetchedBlock
  );

  if (
    mostRecentFetchedBlock !== undefined &&
    oldestFetchedBlock !== undefined
  ) {
    console.log(
      "fetch from current block to most recent fetched block",
      currentBlock,
      mostRecentFetchedBlock
    );
    // From smallest to biggest.
    await fetchProposals(mostRecentFetchedBlock + 1, currentBlock);

    // fetch from the already fetched the oldest block number to hardcoded limit oldest date.
    // ---------| oldest fetched | xxxxxxxxxx <to fetch> xxxxxxxxxx | GENESIS BLOCK
    console.log(
      "fetch from already fetched oldest block to 0",
      oldestFetchedBlock
    );
    // From biggest to smallest
    await fetchProposals(oldestFetchedBlock - 1, 0);
  } else {
    // Fetch all history.
    governanceProposalStore.resetProposals(
      web3Store.chainId,
      fundStore.fund?.address
    );
    console.log("fetch all blocks");
    await fetchProposals(currentBlock, 0);
  }
};
</script>

<style scoped lang="scss">
.tools {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  margin-bottom: 2rem;

  &__success-rate {
    display: flex;
    flex-direction: column;
    align-items: end;
  }

  &__val {
    font-weight: 700;
    font-size: $text-md;
    color: $color-white;
  }

  &__subtext {
    font-weight: 500;
    font-size: $text-sm;
  }
}

.tools__all-activity-btn {
  @include borderGray;
  display: flex;
  flex-direction: row;

  &__subtext {
    color: $color-text-irrelevant;
    font-size: $text-sm;
    font-weight: 500;
    margin: 0 0.75rem;
  }
}

// overrides for expansion-panel
.data_row_card {
  margin-bottom: 2rem;

  // remove outer border
  :deep(.data_row__panel) {
    border: 0;
    border-radius: 0.25rem !important;
    background-color: rgb(var(--v-theme-surface));
  }
  // add more spacing to content inside
  :deep(.v-expansion-panel-text__wrapper) {
    padding-bottom: 2rem;
  }
  // add borders to text fields inside panel
  :deep(.v-expansion-panels) {
    border: 1px solid $color-gray-transparent;
    border-radius: 0.25rem !important;

    .data_row__panel {
      padding: 0;
    }
  }
}
</style>

import { defineStore } from "pinia";
import type { AbiFunctionFragment, AbiInput, EventLog } from "web3";
import { eth } from "web3";
import { ethers } from "ethers";
import type IGovernanceProposal from "~/types/governance_proposal";
import { cleanComplexWeb3Data } from "~/composables/utils";
import RethinkFundGovernor from "~/assets/contracts/RethinkFundGovernor.json";
import GnosisSafeL2JSON from "~/assets/contracts/safe/GnosisSafeL2_v1_3_0.json";
import ZodiacRoles from "~/assets/contracts/zodiac/RolesFull.json";
import GovernableFund from "assets/contracts/GovernableFund.json";
import { useFundStore } from "~/store/fund.store";
import { ProposalStateMapping } from "~/types/enums/governance_proposal";
import { ClockMode } from "~/types/enums/clock_mode";
import { useWeb3Store } from "~/store/web3.store";
import { useToastStore } from "~/store/toast.store";
import { ProposalCalldataType } from "~/types/enums/proposal_calldata_type";

interface IState {
  /* Example fund proposals.
    {
      // Chain ID
      "0xa4b1": {
        // Fund ID
        0x74759a4607B97360956AbFd44cA4B2A0EC2A27C9: {
            // Proposal ID
            "12754787873337135482756554849130912527367661631787941145703427293581378830108": {}
        }
      }
    }
  */
  fundProposals: Record<string, Record<string, Record<string, IGovernanceProposal>>>;
  /* Example from what to what range block history events were already fetched..
  {
    // Chain ID
    "0xa4b1": {
      // Fund ID
      0x74759a4607B97360956AbFd44cA4B2A0EC2A27C9: [
        5000,  // the latest block fetched
        4200   // the oldest block fetched
      ]
    }
  }
  */
  fundProposalsBlockFetchedRanges: Record<string, Record<string, number[]>>;
  connectedAccountProposalsHasVoted: Record<string, Record<string, boolean>>,
}

export const useGovernanceProposalsStore = defineStore({
  id: "governanceProposalStore",
  state: (): IState => ({
    fundProposals: getLocalStorageItem("fundProposals", {}) ?? {},
    fundProposalsBlockFetchedRanges: getLocalStorageItem("fundProposalsBlockFetchedRanges", {}) ?? {},
    connectedAccountProposalsHasVoted: {},
  }),
  getters: {
    fundStore(): any {
      return useFundStore();
    },
    toastStore(): any {
      return useToastStore();
    },
    web3Store(): any {
      return useWeb3Store();
    },
  },
  actions: {
    resetProposals(chainId: string, fundAddress?: string): void {
      if (!fundAddress) return;

      const chainData = this.fundProposals?.[chainId];
      console.log("this.fundProposals: ", this.fundProposals, typeof this.fundProposals)
      if (!(chainData)) {
        this.fundProposals[chainId] = {};
      }
      this.fundProposals[chainId][fundAddress] = {};
      this.fundProposalsBlockFetchedRanges[chainId] = {};
      setLocalStorageItem("fundProposals", {});
      setLocalStorageItem("fundProposalsBlockFetchedRanges",  {});
    },
    storeProposal(chainId: string, fundAddress: string, proposal: IGovernanceProposal): void {
      this.fundProposals[chainId] ??= {};
      this.fundProposals[chainId][fundAddress] ??= {};
      this.fundProposals[chainId][fundAddress][proposal.proposalId] = proposal;
      setLocalStorageItem("fundProposals", cleanComplexWeb3Data(this.fundProposals, true));
    },
    getProposals(chainId: string, fundAddress?: string): IGovernanceProposal[] {
      if (!fundAddress) return [];

      const chainData = this.fundProposals?.[chainId];
      if (!chainData) return [];

      const fundData = chainData[fundAddress];
      if (!fundData) return [];

      return Object.values(this.fundProposals[chainId][fundAddress]);
    },
    getProposal(chainId: string, fundAddress?: string, proposalId?: string): IGovernanceProposal | undefined {
      if (!fundAddress || !proposalId) return undefined;

      const chainData = this.fundProposals?.[chainId];
      if (!chainData) return undefined;

      const fundData = chainData[fundAddress];
      if (!fundData) return undefined;

      return fundData[proposalId];
    },
    hasAccountVoted(proposalId: string): boolean | undefined {
      const activeAccountAddress = this.fundStore.activeAccountAddress;
      if (!activeAccountAddress) return false;
      if (this.connectedAccountProposalsHasVoted?.[proposalId] === undefined) {
        return undefined;
      }
      return this.connectedAccountProposalsHasVoted?.[proposalId][activeAccountAddress];
    },
    fetchHasAccountVoted(proposalId: string): boolean | undefined {
      const activeAccountAddress = this.fundStore.activeAccountAddress;
      if (!activeAccountAddress) return false;
      if (this.connectedAccountProposalsHasVoted?.[proposalId] === undefined) {
        return undefined;
      }
      return this.connectedAccountProposalsHasVoted?.[proposalId][activeAccountAddress];
    },
    getFundProposalsBlockFetchedRanges(chainId: string, fundAddress?: string): number[] | undefined[] {
      if (!fundAddress) return [undefined, undefined];

      const chainData = this.fundProposalsBlockFetchedRanges?.[chainId];
      if (!chainData) return [undefined, undefined];

      const fundData = chainData[fundAddress];
      if (!fundData) return [undefined, undefined];

      return fundData;
    },
    setFundProposalsBlockFetchedRanges(
      chainId: string,
      fundAddress: string,
      latestBlock: number,
      oldestBlock: number,
    ): void {
      this.fundProposalsBlockFetchedRanges[chainId] ??= {};
      this.fundProposalsBlockFetchedRanges[chainId][fundAddress] ??= [];
      const currentRange = this.fundProposalsBlockFetchedRanges[chainId][fundAddress];

      if (currentRange.length) {
        let currentMostRecentBlock = currentRange[0];
        let currentOldestBlock = currentRange[1];

        if (latestBlock > currentMostRecentBlock) {
          currentMostRecentBlock = latestBlock;
        }
        if (oldestBlock < currentOldestBlock) {
          currentOldestBlock = oldestBlock;
        }
        this.fundProposalsBlockFetchedRanges[chainId][fundAddress] = [currentMostRecentBlock, currentOldestBlock];
      } else {
        this.fundProposalsBlockFetchedRanges[chainId][fundAddress] = [latestBlock, oldestBlock];
      }
      setLocalStorageItem("fundProposalsBlockFetchedRanges", cleanComplexWeb3Data(
        this.fundProposalsBlockFetchedRanges, true),
      );
    },
    decodeProposalCreatedEvent(event: EventLog): IGovernanceProposal | undefined {
      if (!event.raw) return undefined;
      const topics = event.raw?.topics as string[];

      // Decode event data.
      const decodedEvent = eth.abi.decodeLog(
        proposalCreatedEventInputs ?? [],
        event.raw?.data ?? "",
        topics.slice(1),
      );
      const proposal = cleanComplexWeb3Data(decodedEvent) as IGovernanceProposal;

      try {
        proposal.descriptionHash = ethers.keccak256(ethers.toUtf8Bytes(proposal.description));
        const parsedDescription = JSON.parse(proposal.description);
        proposal.title = parsedDescription.title;
        proposal.description = parsedDescription.description;
      } catch {
        proposal.title = proposal.description;
      }
      console.log("event decoded");
      return proposal
    },
    decodeProposalCallData(calldata: string): Record<any, any> | undefined{
      // Iterate over each method in ABI to find a match
      const signature = calldata.slice(0, 10);
      const encodedParameters = calldata.slice(10);
      const functionAbi = functionSignaturesMap[signature];
      // console.log("decode signature: ", signature, " ABI ", functionAbi);

      if (!functionAbi?.function?.name) {
        console.warn("No existing function signature found in the GovernableFund ABI for ", signature, functionAbi)
        return undefined;
      }
      const functionAbiInputs = functionAbi?.function?.inputs as AbiInput[]

      try {
        let decoded = this.fundStore.web3.eth.abi.decodeParameters(functionAbiInputs, encodedParameters);
        decoded = cleanComplexWeb3Data(decoded);
        // console.log("decoded data: ", functionAbi.contractName, functionAbi.function.name, decoded);
        return {
          functionName: functionAbi.function.name,
          contractName: functionAbi.contractName,
          decodedCalldata: decoded,
          calldata,
        };
      } catch (error: any) {
        console.error("error while decoding signature: ", signature, error);
      }
      console.error("FAILED decoding signature: ", signature, functionSignaturesMap[signature]);

      return undefined;
    },
    async fetchBlockProposals(blockNumber: bigint) {
      console.log("fetchBlockProposals:", blockNumber);
      const proposalCreatedEvents = await this.fundStore.fundGovernorContract.getPastEvents("ProposalCreated", {
        fromBlock: blockNumber,
        toBlock: blockNumber,
      });
      console.log("fetchBlockProposals events:", proposalCreatedEvents);
      await this.parseProposalCreatedEvents(proposalCreatedEvents);
    },
    /**
     * Example data of one decoded proposal, data that came from the ProposalCreated event:
     *
     * {
     *     "proposalId": "100928362673962953747976977800166144740308816222406020172969996550573666024331",
     *     "proposer": "0x66158bf6752FA6191E70Ab06Cfc345dE0D9A0ba5",
     *     "targets":
     *     [
     *         "0x0dCd5D9cF6DFF56E7Ce2cbed1d39369e1B5f2ac4",
     *         "0x0dCd5D9cF6DFF56E7Ce2cbed1d39369e1B5f2ac4",
     *         "0x0dCd5D9cF6DFF56E7Ce2cbed1d39369e1B5f2ac4",
     *         "0x0dCd5D9cF6DFF56E7Ce2cbed1d39369e1B5f2ac4",
     *         "0x0Ca068aB532114F25a91d083e2af7CEd2A6e602C"
     *     ],
     *     "values":
     *     [
     *         "0",
     *         "0",
     *         "0",
     *         "0",
     *         "0"
     *     ],
     *     "signatures":
     *     [
     *         "",
     *         "",
     *         "",
     *         "",
     *         ""
     *     ],
     *     "calldatas":
     *     [
     *         "0x93a1de3f00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000fc000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000b400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000340000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000addd25a91563696d8567df78d5a01c9a991f9b8000000000000000000000000000000000000000000000000000000000000012000000000000000000000000053d76f967de13e7f95e90196438dce695ecfa957000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064802431fb00000000000000000000000053d76f967de13e7f95e90196438dce695ecfa9570000000000000000000000008f3cf7ad23cd3cadbd9735aff958023239c6a063000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b7b22706f736974696f6e4e616d65223a2253484e222c2276616c756174696f6e536f75726365223a223120496e6368202853484e2f44414929227d000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000248a64e3edd3f521ef2aa6a3e804845b5a1c800800000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000966c697175696443616c63756c6174696f6e526561644f6e6c792828616464726573732c616464726573732c62797465732c616464726573732c616464726573732c626f6f6c2c75696e743235362c75696e743235362c75696e74323536295b5d2c616464726573732c616464726573732c75696e743235362c626f6f6c2c75696e743235362c75696e743235362c61646472657373290000000000000000000000000000000000000000000000000000000000000000000000000000000002846b8ddb710000000000000000000000000000000000000000000000000000000000000100000000000000000000000000067d74a54ac281914019d5b79943388e0f4d417b0000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac40000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000049f05ad4a19eeb98f2f09c86096feefab99f2b4a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001200000000000000000000000006944e4ef181169a12a980d3e8a81f0e6b7e142ad0000000000000000000000008f3cf7ad23cd3cadbd9735aff958023239c6a0630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004f7b22706f736974696f6e4e616d65223a22383053484e2d3230444149222c2276616c756174696f6e536f75726365223a22556e69737761702056322028383053484e2d32304441492f44414929227d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000be0b0c435ea1156f76d3e116fbd5606743ab179a000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001076616c75654f66286164647265737329000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024a48028aa000000000000000000000000067d74a54ac281914019d5b79943388e0f4d417b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000347b22706f736974696f6e4e616d65223a22444f435450222c2276616c756174696f6e536f75726365223a2252657468696e6b227d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac40000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac40000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac4",
     *         "0xe9ae21ea0000000000000000000000000000000000000000000000000000000000000000",
     *         "0xe9ae21ea0000000000000000000000000000000000000000000000000000000000000002",
     *         "0xe9ae21ea0000000000000000000000000000000000000000000000000000000000000003",
     *         "0x33a0480c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac493a1de3f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000116000000000000000000000000000000000000000000000000000000000000021c00000000000000000000000000000000000000000000000000000000000003220000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000820000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000008200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000082000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000820000000000000000000000000000000000000000000000000000000000001040000000000000000000000000000000000000000000000000000000000000108000000000000000000000000000000000000000000000000000000000000010c000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000001140000000000000000000000000000000000000000000000000000000000000118000000000000000000000000000000000000000000000000000000000000011c000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001240000000000000000000000000000000000000000000000000000000000000128000000000000000000000000000000000000000000000000000000000000012c000000000000000000000000000000000000000000000000000000000000013000000000000000000000000000000000000000000000000000000000000001340000000000000000000000000000000000000000000000000000000000000138000000000000000000000000000000000000000000000000000000000000013c000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001440000000000000000000000000000000000000000000000000000000000000148000000000000000000000000000000000000000000000000000000000000014c000000000000000000000000000000000000000000000000000000000000015000000000000000000000000000000000000000000000000000000000000001540000000000000000000000000000000000000000000000000000000000000158000000000000000000000000000000000000000000000000000000000000015c000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001640000000000000000000000000000000000000000000000000000000000000168000000000000000000000000000000000000000000000000000000000000016c000000000000000000000000000000000000000000000000000000000000017000000000000000000000000000000000000000000000000000000000000001740000000000000000000000000000000000000000000000000000000000000178000000000000000000000000000000000000000000000000000000000000017c000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001840000000000000000000000000000000000000000000000000000000000000188000000000000000000000000000000000000000000000000000000000000018c000000000000000000000000000000000000000000000000000000000000019000000000000000000000000000000000000000000000000000000000000001940000000000000000000000000000000000000000000000000000000000000198000000000000000000000000000000000000000000000000000000000000019c00000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001a400000000000000000000000000000000000000000000000000000000000001a800000000000000000000000000000000000000000000000000000000000001ac00000000000000000000000000000000000000000000000000000000000001b000000000000000000000000000000000000000000000000000000000000001b400000000000000000000000000000000000000000000000000000000000001b800000000000000000000000000000000000000000000000000000000000001bc00000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000001c400000000000000000000000000000000000000000000000000000000000001c800000000000000000000000000000000000000000000000000000000000001cc00000000000000000000000000000000000000000000000000000000000001d000000000000000000000000000000000000000000000000000000000000001d400000000000000000000000000000000000000000000000000000000000001d800000000000000000000000000000000000000000000000000000000000001dc00000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000001e400000000000000000000000000000000000000000000000000000000000001e800000000000000000000000000000000000000000000000000000000000001ec00000000000000000000000000000000000000000000000000000000000001f000000000000000000000000000000000000000000000000000000000000001f400000000000000000000000000000000000000000000000000000000000001f800000000000000000000000000000000000000000000000000000000000001fc000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002040000000000000000000000000000000000000000000000000000000000000208000000000000000000000000000000000000000000000000000000000000020c000000000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000002140000000000000000000000000000000000000000000000000000000000000218000000000000000000000000000000000000000000000000000000000000021c000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002240000000000000000000000000000000000000000000000000000000000000228000000000000000000000000000000000000000000000000000000000000022c000000000000000000000000000000000000000000000000000000000000023000000000000000000000000000000000000000000000000000000000000002340000000000000000000000000000000000000000000000000000000000000238000000000000000000000000000000000000000000000000000000000000023c000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002440000000000000000000000000000000000000000000000000000000000000248000000000000000000000000000000000000000000000000000000000000024c000000000000000000000000000000000000000000000000000000000000025000000000000000000000000000000000000000000000000000000000000002540000000000000000000000000000000000000000000000000000000000000258000000000000000000000000000000000000000000000000000000000000025c000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002640000000000000000000000000000000000000000000000000000000000000268000000000000000000000000000000000000000000000000000000000000026c000000000000000000000000000000000000000000000000000000000000027000000000000000000000000000000000000000000000000000000000000002740000000000000000000000000000000000000000000000000000000000000278000000000000000000000000000000000000000000000000000000000000027c000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000002840000000000000000000000000000000000000000000000000000000000000288000000000000000000000000000000000000000000000000000000000000028c000000000000000000000000000000000000000000000000000000000000029000000000000000000000000000000000000000000000000000000000000002940000000000000000000000000000000000000000000000000000000000000298000000000000000000000000000000000000000000000000000000000000029c00000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000002a400000000000000000000000000000000000000000000000000000000000002a800000000000000000000000000000000000000000000000000000000000002ac00000000000000000000000000000000000000000000000000000000000002b000000000000000000000000000000000000000000000000000000000000002b400000000000000000000000000000000000000000000000000000000000002b800000000000000000000000000000000000000000000000000000000000002bc00000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000002c400000000000000000000000000000000000000000000000000000000000002c800000000000000000000000000000000000000000000000000000000000002cc00000000000000000000000000000000000000000000000000000000000002d000000000000000000000000000000000000000000000000000000000000002d400000000000000000000000000000000000000000000000000000000000002d800000000000000000000000000000000000000000000000000000000000002dc00000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000002e400000000000000000000000000000000000000000000000000000000000002e800000000000000000000000000000000000000000000000000000000000002ec00000000000000000000000000000000000000000000000000000000000002f000000000000000000000000000000000000000000000000000000000000002f400000000000000000000000000000000000000000000000000000000000002f800000000000000000000000000000000000000000000000000000000000002fc00000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000304000000000000000000000000000000000000000000000000000000000000030800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000fc00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000b4000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000340000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000addd25a91563696d8567df78d5a01c9a991f9b800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000002000000000000000000000000053d76f967de13e7f95e90196438dce695ecfa9570000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000020802431fb00000000000000000000000053d76f967de13e7f95e90196438dce6900000000000000000000000000000000000000000000000000000000000000205ecfa9570000000000000000000000008f3cf7ad23cd3cadbd9735aff9580232000000000000000000000000000000000000000000000000000000000000002039c6a06300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003b00000000000000000000000000000000000000000000000000000000000000207b22706f736974696f6e4e616d65223a2253484e222c2276616c756174696f6e0000000000000000000000000000000000000000000000000000000000000020536f75726365223a223120496e6368202853484e2f44414929227d000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000248a64e3edd3f521ef2aa6a3e804845b5a1c80080000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000009600000000000000000000000000000000000000000000000000000000000000206c697175696443616c63756c6174696f6e526561644f6e6c7928286164647265000000000000000000000000000000000000000000000000000000000000002073732c616464726573732c62797465732c616464726573732c6164647265737300000000000000000000000000000000000000000000000000000000000000202c626f6f6c2c75696e743235362c75696e743235362c75696e74323536295b5d00000000000000000000000000000000000000000000000000000000000000202c616464726573732c616464726573732c75696e743235362c626f6f6c2c756900000000000000000000000000000000000000000000000000000000000000206e743235362c75696e743235362c6164647265737329000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000028400000000000000000000000000000000000000000000000000000000000000206b8ddb7100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000100000000000000000000000000067d74a54ac281914019d5b79943388e00000000000000000000000000000000000000000000000000000000000000200f4d417b0000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e00000000000000000000000000000000000000000000000000000000000000201b5f2ac4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e00000000000000000000000000000000000000000000000000000000000000201b5f2ac4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000002000000000000000000000000049f05ad4a19eeb98f2f09c86096feefa0000000000000000000000000000000000000000000000000000000000000020b99f2b4a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000001200000000000000000000000006944e4ef181169a12a980d3e8a81f0e60000000000000000000000000000000000000000000000000000000000000020b7e142ad0000000000000000000000008f3cf7ad23cd3cadbd9735aff9580232000000000000000000000000000000000000000000000000000000000000002039c6a0630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004f00000000000000000000000000000000000000000000000000000000000000207b22706f736974696f6e4e616d65223a22383053484e2d3230444149222c22760000000000000000000000000000000000000000000000000000000000000020616c756174696f6e536f75726365223a22556e697377617020563220283830530000000000000000000000000000000000000000000000000000000000000020484e2d32304441492f44414929227d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000be0b0c435ea1156f76d3e116fbd5606743ab179a00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002076616c75654f6628616464726573732900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000020a48028aa000000000000000000000000067d74a54ac281914019d5b79943388e00000000000000000000000000000000000000000000000000000000000000200f4d417b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000207b22706f736974696f6e4e616d65223a22444f435450222c2276616c7561746900000000000000000000000000000000000000000000000000000000000000206f6e536f75726365223a2252657468696e6b227d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000200000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000dcd5d9cf6dff56e7ce2cbed1d39369e1b5f2ac4"
     *     ],
     *     "voteStart": "1718191316",
     *     "voteEnd": "1718623316",
     *     "description": "{\"title\":\"01 - NAV Methods\",\"description\":\"See details bellow\"}"
     * }
     *
     * TODO check first few 8 bytes of calldatas to see if the function signature matches any of ours, for example
     * to compare them with function signatures of our ABIs
     * TODO or just try decoding calldatas with our ABIs
     */
    async parseProposalCreatedEvents(events: any[]) {
      if (!this.fundStore.fund?.governanceToken.decimals) {
        console.error("No fund governance token decimals found.")
        this.toastStore.errorToast("No fund governance token decimals found.")
        return
      }
      if (!this.fundStore.fund.clockMode?.mode) {
        console.error("Fund clock mode is unknown.")
        this.toastStore.errorToast("Fund clock mode is unknown.")
        return
      }
      const roleModAddress = await this.fundStore.getRoleModAddress();

      for (const event of events) {
        console.log("event");
        console.log(event);
        const proposal = this.decodeProposalCreatedEvent(event);
        if (!proposal) continue;

        const block = await this.fundStore.web3.eth.getBlock(event.blockNumber);
        proposal.createdTimestamp = Number(block.timestamp);
        proposal.createdDatetimeFormatted = formatDate(new Date(Number(block.timestamp) * 1000));
        proposal.createdBlockNumber = event.blockNumber;

        // const voteStartDate = new Date(Number(proposal.voteStart) * 1000);
        // const voteEndDate = new Date(Number(proposal.voteEnd) * 1000);
        // console.log("Vote Start Date: ", voteStartDate);
        // console.log("Vote End Date: ", voteEndDate);

        const proposalState = await this.fundStore.fundGovernorContract.methods.state(proposal.proposalId).call();
        proposal.state = ProposalStateMapping[proposalState]

        const votes = await this.fundStore.fundGovernorContract.methods.proposalVotes(proposal.proposalId).call();
        console.log("proposal votes: ", votes);

        console.log("get total supply at blockNumber: ", proposal.createdBlockNumber);
        // Get the Governance Token total supply of when the proposal was created.
        let totalSupply;
        try {
          totalSupply = await this.fundStore.fundGovernanceTokenContract.methods.totalSupply().call({}, proposal.createdBlockNumber);
          proposal.totalSupply = totalSupply;
          proposal.totalSupplyFormatted = formatTokenValue(totalSupply, this.fundStore.fund?.governanceToken?.decimals);
        } catch (error: any) {
        // Sometimes it happens: missing trie node
          console.error("failed fetching total supply", error);
          proposal.totalSupplyFormatted = "N/A"
        }

        console.log("proposal created blockNumber ", proposal.createdBlockNumber, " timestamp ", proposal.createdTimestamp);
        try {
        // To get quorum in time, we have to pass the timePoint, but it depends on the clock mode.
        // If clock mode is:
        // - timestamp: use proposal created timestamp
        // - blocknumber: use proposal created block number
          const timePoint = this.fundStore.fund?.clockMode?.mode === ClockMode.BlockNumber ?
            proposal.createdBlockNumber :
            proposal.createdTimestamp;

          const quorumWhenProposalCreated = await this.fundStore.fundGovernorContract.methods.quorumNumerator(timePoint).call()
          proposal.quorumVotes = quorumWhenProposalCreated;
          proposal.quorumVotesFormatted = formatTokenValue(quorumWhenProposalCreated, this.fundStore.fund?.governanceToken?.decimals);
        } catch (e: any) {
          console.error("error fetching quorumVotes: ", e);
          proposal.quorumVotesFormatted = "N/A";
        }

        console.log("parse votes");
        if (votes) {
          const totalVotes = votes.forVotes + votes.abstainVotes + votes.againstVotes;
          proposal.totalVotes = totalVotes;
          proposal.totalVotesFormatted = formatTokenValue(totalVotes, this.fundStore.fund?.governanceToken.decimals);
          proposal.forVotes = votes.forVotes;
          proposal.abstainVotes = votes.abstainVotes;
          proposal.againstVotes = votes.againstVotes;
          proposal.forVotesFormatted = formatTokenValue(votes.forVotes, this.fundStore.fund?.governanceToken.decimals);
          proposal.abstainVotesFormatted = formatTokenValue(votes.abstainVotes, this.fundStore.fund?.governanceToken.decimals);
          proposal.againstVotesFormatted = formatTokenValue(votes.againstVotes, this.fundStore.fund?.governanceToken.decimals);

          if (proposal.quorumVotes) {
            let approval = Number(votes.forVotes) / Number(proposal.quorumVotes);
            // Limit approval percentage to 100% max.
            if (approval > 1) {
              approval = 1;
            }
            proposal.approval = approval;
            proposal.approvalFormatted = formatPercent(approval, false);
          } else {
            proposal.approvalFormatted = "N/A";
          }

          // Participation is totalVotes / totalSupply
          if (totalSupply) {
            let participation = Number(totalVotes) / Number(totalSupply);
            // Limit participation percentage to 100% max.
            if (participation > 1) {
              participation = 1;
            }
            proposal.participation = participation;
            proposal.participationFormatted = formatPercent(participation, false);
          } else {
            proposal.participationFormatted = "N/A";
          }
        }

        proposal.calldatasDecoded = [];
        proposal.calldataTypes = [];

        proposal.calldatas.forEach((calldata, i) => {
          const decodedCalldata = this.decodeProposalCallData(calldata);
          proposal.calldatasDecoded.push(decodedCalldata);

          if (decodedCalldata?.functionName === "updateNav") {
            proposal.calldataTypes.push(ProposalCalldataType.NAV_UPDATE);
          } else if (proposal.targets[i] === this.fundStore.fund?.safeAddress) {
            proposal.calldataTypes.push(ProposalCalldataType.DIRECT_EXECUTION);
          } else if (proposal.targets[i] === roleModAddress) {
            proposal.calldataTypes.push(ProposalCalldataType.PERMISSIONS);
          } else {
            proposal.calldataTypes.push(ProposalCalldataType.UNDEFINED);
          }
        });
        proposal.calldataTags = [...new Set(proposal.calldataTypes.filter(
          calldataType => calldataType !== ProposalCalldataType.UNDEFINED,
        ))];

        console.log("ZodiacRolesV1ModifierUpgradeableBeaconAddress: ", this.web3Store.ZodiacRolesV1ModifierUpgradeableBeaconAddress)

        this.storeProposal(this.web3Store.chainId, this.fundStore.fund?.address, proposal)
      }
    },
  },
});

const proposalCreatedEventInputs = RethinkFundGovernor.abi.find(
  event => event.name === "ProposalCreated" && event.type === "event",
)?.inputs ?? [];

/**
 * Extract all function signatures from GovernableFund ABI
 * Iterate over all functions in GovernableFund ABI and generate a map of functionSignatureHash as key
 * and ABI function fragment as value. This will be used when decoding proposal call datas.
 */
const functionSignaturesMap: Record<string, any> = {};

// Iterate over different ABIs to extract function signatures that will later be used
// to decode proposal call data.
const contractsToExtractFunctionSignatures = [
  {
    abi: GovernableFund.abi,
    name: "GovernableFund",
  },
  {
    abi: GnosisSafeL2JSON.abi,
    name: "GnosisSafeL2",
  },
  {
    abi: ZodiacRoles.abi,
    name: "ZodiacRoles",
  },
];

contractsToExtractFunctionSignatures.forEach(contract => {
  contract.abi.forEach(item => {
    if (item.type === "function") {
      const functionSignatureHash = eth.abi.encodeFunctionSignature(item as AbiFunctionFragment);
      functionSignaturesMap[functionSignatureHash] = {
        function: item,
        contractName: contract.name,
      };
    }
  });
});
